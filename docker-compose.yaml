# ============================================================================
# KORTIX SUPER WORKER DOCKER COMPOSE - LOCAL DEVELOPMENT
# ============================================================================
# This Docker Compose file runs Kortix Super Worker services (Backend, Worker, Frontend, Redis)
#
# ‚ö†Ô∏è  IMPORTANT LIMITATION - LOCAL SUPABASE:
# Currently, local Supabase (via `npx supabase start`) is NOT supported with
# Docker Compose due to network configuration complexity.
#
# TODO: Integrate Supabase services directly into this compose file to enable
#       full Docker-based local development with proper network configuration.
#
# CURRENT WORKAROUND:
# - Use cloud Supabase for Docker Compose setup
# - OR run everything manually (no Docker) to use local Supabase
#
# Quick Start:
#   docker compose up -d          # Start all services
#   docker compose down           # Stop all services
#   docker compose logs -f        # View all logs
#
# Access:
#   - Kortix Super Worker Frontend:     http://localhost:3000
#   - Kortix Super Worker Backend API:  http://localhost:8000
# ============================================================================

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./backend/services/docker/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf --save 60 1 --loglevel warning
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  backend:
    image: ghcr.io/suna-ai/suna-backend:latest
    platform: linux/amd64
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ./backend/.env:/app/.env:ro
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_SSL=False
    depends_on:
      redis:
        condition: service_healthy
      worker:
        condition: service_started
    # -------------------------------------------------------------------------
    # STARTUP PATCHES:
    # 1. Disable local JWT signature verification (Supabase handles auth)
    # 2. Add local mode bypass to trial endpoint (skip Stripe in local mode)
    # -------------------------------------------------------------------------
    command:
      - sh
      - -c
      - |
        echo "üîß Applying backend patches..."
        
        # Patch 1: Disable local JWT signature verification
        sed -i 's/"verify_signature": True/"verify_signature": False/g' /app/core/utils/auth_utils.py
        echo "‚úÖ Auth patched"
        
        # Patch 2: Add local mode bypass to trial endpoint
        cat > /tmp/trial_patch.py << 'PYPATCH'
        filepath = '/app/core/billing/endpoints/trial.py'
        with open(filepath, 'r') as f:
            content = f.read()
        
        if 'ENV_MODE == EnvMode.LOCAL' in content:
            print('Trial endpoint already patched')
        else:
            old_import = 'from fastapi import APIRouter, HTTPException, Depends'
            new_import = '''from fastapi import APIRouter, HTTPException, Depends
        from core.utils.config import config, EnvMode'''
            content = content.replace(old_import, new_import)
            
            old_func = '''@router.post("/trial/start")
        async def start_trial(
            request: TrialStartRequest,
            account_id: str = Depends(verify_and_get_user_id_from_jwt)
        ) -> Dict:
            try:'''
            
            new_func = '''@router.post("/trial/start")
        async def start_trial(
            request: TrialStartRequest,
            account_id: str = Depends(verify_and_get_user_id_from_jwt)
        ) -> Dict:
            if config.ENV_MODE == EnvMode.LOCAL:
                return {
                    "success": True,
                    "message": "Trial activated (local mode)",
                    "redirect_url": request.success_url or "https://kortix.darwisyah.com/dashboard"
                }
            try:'''
            
            content = content.replace(old_func, new_func)
            
            with open(filepath, 'w') as f:
                f.write(content)
            print('‚úÖ Trial endpoint patched for local mode')
        PYPATCH
        python3 /tmp/trial_patch.py
        
        echo "üöÄ Starting backend server..."
        exec uv run uvicorn api:app --host 0.0.0.0 --port 8000

  worker:
    image: ghcr.io/suna-ai/suna-backend:latest
    platform: linux/amd64
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: uv run dramatiq --skip-logging --processes 4 --threads 4 run_agent_background
    volumes:
      - ./backend/.env:/app/.env:ro
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_SSL=False
    depends_on:
      redis:
        condition: service_healthy

  frontend:
    init: true
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_BACKEND_URL: ${NEXT_PUBLIC_BACKEND_URL:-http://localhost:8000/v1}
        NEXT_PUBLIC_URL: ${NEXT_PUBLIC_URL:-http://localhost:3000}
        NEXT_PUBLIC_ENV_MODE: ${NEXT_PUBLIC_ENV_MODE:-LOCAL}
    ports:
      - "3000:3000"
    depends_on:
      - backend
    # -------------------------------------------------------------------------
    # Environment variables for auth and URL handling
    # -------------------------------------------------------------------------
    environment:
      - NEXTAUTH_URL=https://kortix.darwisyah.com
      - NEXT_PUBLIC_APP_URL=https://kortix.darwisyah.com
      - NEXT_PUBLIC_URL=https://kortix.darwisyah.com
      - HOST=0.0.0.0
      - PORT=3000
    # -------------------------------------------------------------------------
    # STARTUP PATCHES:
    # 1. Fix server.js: Prevent Next.js from using HOSTNAME=0.0.0.0 for URLs
    # 2. Fix auth callback: Force correct origin instead of nextUrl.origin
    # -------------------------------------------------------------------------
    command:
      - sh
      - -lc
      - |
        echo "üîß Applying startup patches..."

        node -e "
        const fs = require('fs');
        const serverPath = '/app/server.js';
        let content = fs.readFileSync(serverPath, 'utf8');
        const original = content;
        content = content.replace(
          \"const hostname = process.env.HOSTNAME || '0.0.0.0'\",
          \"const hostname = process.env.HOST || '0.0.0.0'\"
        );
        if (content !== original) {
          fs.writeFileSync(serverPath, content);
          console.log('‚úÖ Patched server.js: HOSTNAME -> HOST');
        } else {
          console.log('‚ÑπÔ∏è  server.js already patched or pattern not found');
        }
        "

        node -e "
        const fs = require('fs');
        const callbackPath = '/app/.next/server/app/auth/callback/route.js';
        if (fs.existsSync(callbackPath)) {
          let content = fs.readFileSync(callbackPath, 'utf8');
          const original = content;
          content = content.replace(
            /a\.nextUrl\.origin\s*\|\|\s*['\"]https:\/\/kortix\.darwisyah\.com['\"]/g,
            '\"https://kortix.darwisyah.com\"'
          );
          if (content !== original) {
            fs.writeFileSync(callbackPath, content);
            console.log('‚úÖ Patched auth callback: forced correct origin');
          } else {
            console.log('‚ÑπÔ∏è  auth callback already patched or pattern not found');
          }
        } else {
          console.log('‚ö†Ô∏è  auth callback file not found at expected path');
        }
        "

        echo "üöÄ Starting Next.js server..."
        exec node /app/server.js

volumes:
  redis_data:
